# DrawingCanvasコンポーネントリファクタリング計画

## 現状の評価

### 全体構造

現在のDrawingCanvasコンポーネントとその関連ファイルは以下の構成になっています：

- `index.tsx`: メインのDrawingCanvasコンポーネント（359行）
- `use-drawing-store.ts`: 描画状態を管理するカスタムフック（196行）
- `use-drawing-history.ts`: 描画履歴を管理するカスタムフック（47行）
- `drawing-style.ts`: 描画スタイルの定義（60行）
- `line-color-picker.tsx`: 色選択コンポーネント（61行）
- `line-width-picker.tsx`: 線幅選択コンポーネント（67行）
- `save-image-button.tsx`: 画像保存ボタンコンポーネント（47行）

### 問題点

1. **単一責任の原則（SRP）違反**:
   - `index.tsx`が359行と非常に長く、複数の責務を持っている
   - 描画ロジック、UI表示、イベント処理が混在している

2. **状態管理の複雑さ**:
   - `useDrawingStore`と`useDrawingHistory`の間で責任の分離が不明確
   - 履歴管理が2箇所（`useDrawingHistory`とIndexedDBの両方）で行われている

3. **コードの重複**:
   - キャンバス操作のロジックが複数の場所に散在している

4. **テスト容易性の低さ**:
   - 責務が明確に分離されていないため、単体テストが困難

5. **拡張性の制約**:
   - 新機能追加時に既存コードの変更が必要になる可能性が高い

## リファクタリング計画

### フェーズ1: コンポーネントの責務分離

1. **DrawingCanvasコンポーネントの分割**:
   - `DrawingCanvas`: 全体のコンテナコンポーネント
   - `CanvasArea`: 描画領域とキャンバス操作に特化したコンポーネント
   - `ToolBar`: 描画ツール（色、線幅、消しゴムなど）を管理するコンポーネント
   - `DrawingDialog`: 描画リスト表示ダイアログコンポーネント

2. **カスタムフックの整理**:
   - `useCanvas`: キャンバス操作に関するロジックを集約
   - `useDrawingStore`: データ永続化に特化
   - `useDrawingHistory`: 履歴管理に特化

### フェーズ2: 描画ロジックのリファクタリング

1. **純粋関数による描画ロジックの分離**:
   - `drawing-core.ts`モジュールの作成: 描画に関する純粋関数群を定義
   - 状態変更を返り値として表現する関数設計
   - ポインターイベント処理の最適化

2. **状態管理の改善**:
   - 不変データ構造を使用した状態更新
   - 副作用の分離と明確化

### フェーズ3: データ永続化の改善

1. **IndexedDBとの連携強化**:
   - データアクセスレイヤーの抽象化
   - エラーハンドリングの改善

2. **履歴管理の一元化**:
   - メモリ内履歴とIndexedDB履歴の統合

### 実装計画

#### バッチ1: コンポーネント分割

1. `CanvasArea`コンポーネントの作成
   - キャンバス要素とポインターイベント処理を移動
   - `useCanvas`フックの作成

2. `ToolBar`コンポーネントの作成
   - 描画ツールUIを移動
   - ツール選択ロジックを整理

3. `DrawingDialog`コンポーネントの作成
   - 描画リスト表示ダイアログを分離

#### バッチ2: 描画ロジックの改善

1. `drawing-core.ts`モジュールの実装
   - 描画関連の純粋関数群を定義
   - 入力と出力が明確な関数設計
   - 状態変更を返り値として表現
   - ポインターイベント処理の最適化

2. カスタムフックの整理
   - `useCanvas`の機能拡張
   - `useDrawingStore`と`useDrawingHistory`の責務明確化
   - バッチ1で導入された`useCallback`の削除（React Compilerを使用しているため不要）

#### バッチ3: データ永続化と履歴管理の改善

1. データアクセスレイヤーの抽象化
   - リポジトリパターンの導入検討

2. 履歴管理の一元化
   - メモリ内履歴とIndexedDB履歴の統合

## 期待される効果

1. **コードの可読性向上**:
   - 責務が明確に分離され、各ファイルの行数が減少
   - 関心の分離により、コードの理解が容易に

2. **保守性の向上**:
   - 変更の影響範囲が限定的に
   - バグ修正が容易に

3. **拡張性の向上**:
   - 新機能追加時の既存コード変更が最小限に
   - インターフェイスを通じた疎結合な設計

4. **テスト容易性の向上**:
   - 単体テストが書きやすくなる
   - モック化が容易になる

5. **純粋関数型アプローチの利点**:
   - 予測可能な動作と副作用の明示的な管理
   - デバッグの容易さと状態追跡の透明性
   - 関数の再利用性と組み合わせの柔軟性
   - 並行処理の安全性向上

## 注意点

- オーバーエンジニアリングを避けるため、各フェーズで実際の複雑さを評価
- ユーザー体験を損なわないよう、パフォーマンスを常に考慮
- 既存機能の動作を維持（リグレッションを防止）
- React Compilerを使用しているため、`useCallback`や`useMemo`などのキャッシュ戦略は不要

## 進捗状況

### 2024-03-05: バッチ1完了

コンポーネントの責務分離を実施し、以下のファイルを新規作成しました：

1. `useCanvas.ts` - キャンバス操作のロジックを集約したカスタムフック
   - 描画処理
   - ポインターイベント処理
   - リサイズ処理

2. `CanvasArea.tsx` - 描画領域コンポーネント
   - キャンバス要素の表示
   - `useCanvas`フックの利用

3. `ToolBar.tsx` - ツールバーコンポーネント
   - 色・線幅選択
   - 消しゴム・ペンのみモード切替
   - 履歴操作
   - 保存機能

4. `DrawingDialog.tsx` - 描画リスト表示ダイアログ
   - 描画一覧表示
   - 描画選択
   - 新規作成機能

メインの`index.tsx`は、これらのコンポーネントを組み合わせるコンテナーとしての役割に簡略化されました。これにより、各コンポーネントの責務が明確に分離され、コードの可読性と保守性が向上しました。

次のステップでは、描画ロジックのさらなる改善と状態管理の最適化を行う予定です。

### 2024-03-06: バッチ2完了

描画ロジックのリファクタリングを実施し、以下の改善を行いました：

1. `drawing-core.ts` - 描画関連の純粋関数を定義するモジュールを新規作成
   - `applyDrawingStyle`: 描画スタイルの適用
   - `calculateMidPoint`: 中点計算
   - `drawSmoothLine`: 滑らかな線の描画
   - `clearCanvas`: キャンバスクリア
   - `resizeCanvasToParent`: キャンバスリサイズ
   - `isAllowedPointerType`: ポインタータイプ判定

2. `useCanvas.ts` - 純粋関数を使用するようにリファクタリング
   - 描画ロジックを `drawing-core.ts` に移動
   - 状態管理と副作用を分離

3. `CanvasArea.tsx` - 描画スタイル適用ロジックを純粋関数に置き換え

4. `useDrawingHistory.ts` - 履歴管理の改善
   - タイムスタンプ付きの履歴エントリ
   - 最大履歴数の制限
   - 履歴クリア機能の追加
   - データベース保存ロジックの分離

5. `index.tsx` - コンテナコンポーネントの最適化
   - 不要な状態と副作用の削除
   - 履歴管理の改善を反映

これらの変更により、以下の効果が得られました：

- **関心の分離**: 描画ロジックと状態管理が明確に分離
- **再利用性の向上**: 純粋関数による機能の再利用が容易に
- **テスト容易性**: 純粋関数は入出力が明確で、テストが容易
- **コードの可読性**: 各関数の責務が明確で、理解しやすい
- **保守性の向上**: 変更の影響範囲が限定的に

次のステップでは、データ永続化と履歴管理のさらなる改善を行う予定です。
