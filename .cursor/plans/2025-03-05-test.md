# テスト戦略の見直し計画

## 現状の評価

### テストの現状分析

現在のテストコードを分析した結果、以下の問題点が見られます：

1. **モックの過剰使用**:
   - Canvas API、IndexedDB、requestAnimationFrameなど、ほぼすべての外部依存がモック化されている
   - モックが複雑で、実際の動作を正確に再現できているか不明確
   - テストが実装の詳細に強く結合しており、リファクタリングに弱い

2. **テストの有効性**:
   - 多くのテストが「エラーが発生しないこと」のみを検証している
   - 実際の機能や振る舞いを検証するテストが少ない
   - 例: `expect(() => result.current.clearCanvas()).not.toThrow()`のようなテスト

3. **テストカバレッジの偏り**:
   - ユニットテストが中心で、統合テストや E2E テストが不足
   - ユーザー体験の観点からのテストが欠如している

4. **テストの保守性**:
   - テストコードが実装の詳細に依存しており、内部実装の変更でテストが壊れやすい
   - テストコード自体が複雑で理解しにくい

5. **テストの実行環境**:
   - happy-dom を使用しているが、Canvas API のサポートが不完全
   - 実際のブラウザ環境との差異がテスト結果に影響している可能性がある

### 現在のテスト手法

1. **ユニットテスト**:
   - `vitest` と `@testing-library/react` を使用
   - カスタムフックのテストには `renderHook` を使用
   - コンポーネントのテストには `render` を使用

2. **モック戦略**:
   - `vi.mock()` を使用して外部依存をモック化
   - `vitest-setup.ts` で Canvas API などのグローバルオブジェクトをモック化

3. **テスト環境**:
   - happy-dom を使用した仮想 DOM 環境
   - ブラウザ API の一部をモック化

## テスト戦略の計画

### 基本方針

1. **テストピラミッドの再構築**:
   - ユニットテスト: 純粋関数と分離された小さなロジックに集中
   - 統合テスト: コンポーネント間の連携や状態管理の検証
   - E2E テスト: 実際のユーザー体験を検証

2. **テスト対象の優先順位付け**:
   - ビジネスロジック > UI コンポーネント > ユーティリティ関数
   - 複雑さ・変更頻度・重要度に基づいて優先順位を決定

3. **モック戦略の見直し**:
   - 必要最小限のモックに留める
   - 実装の詳細ではなく、インターフェースに対してモック化
   - テスト用のファサードやアダプターの導入を検討

4. **テスト環境の改善**:
   - Canvas API のテストに適した環境の検討（jsdom や実ブラウザ）
   - テスト用のヘルパー関数やカスタムマッチャーの整備

### 具体的な改善計画

1. **純粋関数のテスト強化**:
   - `drawing-core.ts` の純粋関数は、モックを最小限に抑えた単体テストを実施
   - 入力と出力の検証に集中し、内部実装の詳細にはこだわらない
   - プロパティベーステストの導入を検討

2. **カスタムフックのテスト改善**:
   - `useCanvas` などのフックは、公開 API と状態変化のみをテスト
   - 内部実装の詳細に依存しないテストケースの設計
   - テスト用のラッパーコンポーネントの活用

3. **コンポーネント統合テストの導入**:
   - 個別コンポーネントではなく、機能単位でのテスト
   - ユーザーインタラクションを中心としたテストシナリオ
   - 実際の DOM 操作とイベントの検証

4. **E2E テストの導入**:
   - Playwright や Cypress を使用した実ブラウザテスト
   - 主要なユーザーフローのテスト自動化
   - 視覚的リグレッションテストの検討

5. **テストデータとフィクスチャの整備**:
   - テストデータの一元管理
   - 再利用可能なテストフィクスチャの作成
   - テストヘルパー関数の整備

### 実装ロードマップ

1. **フェーズ1: テスト基盤の整備** (1週間)
   - テスト環境の見直しと改善
   - テストヘルパーとユーティリティの整備
   - テストデータとフィクスチャの作成

2. **フェーズ2: 既存テストのリファクタリング** (2週間)
   - 純粋関数のテスト改善
   - カスタムフックのテスト見直し
   - 不要なモックの削除と簡素化

3. **フェーズ3: 新しいテスト手法の導入** (2週間)
   - コンポーネント統合テストの追加
   - E2E テスト環境のセットアップ
   - 主要ユーザーフローの E2E テスト実装

4. **フェーズ4: テスト自動化とCI/CD統合** (1週間)
   - テスト実行の自動化
   - CI/CD パイプラインへの統合
   - テストレポートとカバレッジ分析の自動化 